# Project Phoenix: 경기장 퇴장 경로 추천 시스템

> **프로젝트 목표:** 경기 종료 직후, 실시간 교통 데이터를 기반으로 경기장 주변의 혼잡을 예측하고, 사용자가 최악의 인파를 피해 귀가할 수 있는 최적의 **'쾌적 경로'**를 추천하는 데이터 기반 특화 서비스 개발

---

## 1. 프로젝트 개요

### 1.1. 해결하고자 하는 문제
- 프로스포츠 경기 관람 후, 수만 명의 인파가 동시에 퇴장하며 발생하는 극심한 교통 및 도보 혼잡
- 이로 인한 귀가 시간 지연, 불쾌한 경험, 압사 사고 등의 잠재적 위험

### 1.2. 우리의 해결책
- 실시간 대중교통 혼잡도 API 데이터를 기반으로, 경기장 주변의 '혼잡 패턴'을 해석하는 **GNN(그래프 신경망)** 모델 개발
- GNN이 추론한 '실시간 경로별 비용'을 **A\* 알고리즘**에 적용하여, 사용자의 **좌석**에서부터 최종 **목적지**까지의 최적의 **'쾌적 경로'**를 동적으로 탐색
- **네이버 지도 API**와 연동하여 '최단 시간', '최소 도보', '최소 환승' 경로를 함께 제공함으로써 사용자 선택권 극대화

### 1.3. 핵심 기술 스택
- **Backend:** FastAPI (Python)
- **Frontend:** React / Vue.js
- **ML/Data:** PyTorch Geometric (GNN), XGBoost, scikit-learn, osmnx, NetworkX
- **Database:** SQLite
- **DevOps & Tools:** VS Code, GitHub (`jsm0308/sports`), Google Colab (GPU), Streamlit (Dashboard)

---

## 2. 핵심 기술 과제 및 최종 확정 방안

### 2.1. 휴리스틱 기반 학습과 하이퍼파라미터
GNN은 복잡한 학습 대신, 우리가 정의한 명확한 **'규칙(Heuristic)'**을 주어진 상황에 맞게 그래프 전체에 **'적용'**하고 **'전파'**하는 역할을 합니다. 우리가 직접 설정하고 튜닝할 핵심 파라미터는 다음과 같습니다.

- **`subway_congestion_penalty`**: 지하철 혼잡도('혼잡' 상태)가 탐지되었을 때 해당 역으로 향하는 경로에 부여할 비용 배율 (예: 2.0배)
- **`bus_congestion_penalty`**: 버스 혼잡도가 탐지되었을 때 해당 정류장으로 향하는 경로에 부여할 비용 배율 (예: 1.5배)
- **`weather_discomfort_factor`**: 폭염(>33℃), 한파(<-5℃), 강풍 등 불쾌한 날씨일 때 500m 이상 도보가 포함된 경로에 부여할 추가 비용 배율 (예: 1.3배)
- **`transfer_penalty`**: 환승(지하철->버스 등)이 발생할 때마다 부여할 고정 추가 시간 비용 (예: 300초)

### 2.2. 날씨 데이터 활용 방안
'비'라는 단일 조건이 아닌, **'이동의 쾌적성'**에 영향을 주는 모든 기상 요소를 반영합니다. 기상청 API를 통해 **'기온', '풍속', '하늘 상태'** 데이터를 가져와, 특정 임계값(예: 기온 33도 이상)을 넘을 경우 `weather_discomfort_factor`를 활성화하여 장거리 도보 경로의 비용을 높게 책정합니다. 이는 야구와 축구 모두에 적용 가능합니다.

### 2.3. 경로 옵션 및 범위 처리
최종적으로 사용자에게 아래 **4가지 경로**를 제공하여 선택권을 보장합니다.
1.  **Phoenix 쾌적 경로 (우리 모델)**
2.  **네이버 최단 시간 경로**
3.  **네이버 최소 도보 경로**
4.  **네이버 최소 환승 경로**

약 2.5km를 기준으로 주변 노드/엣지 데이터를 로드하지만, A* 알고리즘은 경계선에 구애받지 않고 가장 효율적인 **'체크포인트(환승 지점)'**를 동적으로 탐색합니다.

---

## 3. 대규모 실행 계획 (Action Plan To-do List)

### Phase 1: 프로젝트 기반 구축 및 데이터 수집/처리
- **목표:** 개발 환경 구축, GitHub 저장소 설정, 모든 정적/과거 데이터 확보 및 DB 구축 완료.

| 기능/컴포넌트 | 세부 Task (To-do) |
| :--- | :--- |
| **Project Setup** | 1. **VS Code**를 기본 IDE로 설정, 팀원 간 Code Formatter(예: Black, Prettier) 통일 |
| | 2. `jsm0308/sports` 저장소에 `Project-Phoenix` 브랜치 생성 및 팀원 권한 설정 |
| | 3. `README.md` 파일에 v7.0 기반의 프로젝트 개요, 목표, 기술 스택, API 목록 업데이트 |
| | 4. **GitHub Issues**를 사용하여 Phase별 Task 생성 및 담당자 할당 |
| **API Key 확보** | 5. **네이버 클라우드 플랫폼:** Maps API (Directions 5 - 최단시간/최소도보/최소환승, Geocoding) |
| | 6. **공공데이터포털:** 서울특별시 도시철도 실시간 혼잡도, 서울특별시 버스도착정보조회 서비스 |
| | 7. **기상청:** 단기예보 조회서비스 API (기온, 풍속, 하늘상태 데이터용) |
| **Data Sourcing** | 8. Python `requests`, `BeautifulSoup4`로 KBO/K-리그 2022-2024년 경기 데이터 크롤링 |
| | 9. Python `osmnx` 라이브러리로 서울시 전체의 도로/인도/건물 데이터를 포함하는 GraphML 파일 생성 |
| **DB & Graph 구축** | 10. `SQLite`를 사용하여 `phoenix.db` 생성 및 테이블 스키마 정의 |
| | 11. 크롤링한 과거 경기 데이터를 DB에 적재하는 Python 스크립트 작성 (`scripts/load_past_games.py`) |
| | 12. `osmnx`로 생성한 GraphML 파일에서 잠실/상암 경기장 반경 3km 내 그래프 데이터 추출 |

### Phase 2: 핵심 모델 개발 및 백엔드 API MVP
- **목표:** 관중 수 예측 모델, GNN 비용 추론 모델의 프로토타입 개발 및 기본 기능을 갖춘 백엔드 API 구축.

| 기능/컴포넌트 | 세부 Task (To-do) |
| :--- | :--- |
| **관중 수 예측 모델**| 13. VS Code에서 `scikit-learn`, `XGBoost`를 사용하여 관중 수 예측 모델 학습 (2022-2023 데이터로 학습, 2024 데이터로 검증) |
| | 14. 학습된 모델을 `attendance_model.pkl` 파일로 저장 |
| **GNN 모델 개발** | 15. `PyTorch Geometric` 라이브러리를 사용하여 GNN 모델 아키텍처(GCN) 설계 |
| | 16. '휴리스틱 규칙'(`subway_congestion_penalty` 등)을 정의하는 Python 함수 작성 (`src/models/heuristic_labeler.py`) |
| | 17. 과거 경기 데이터를 기반으로 GNN 모델 학습 파이프라인 구축. GPU 필요 시, 관련 코드/데이터를 **Google Colab**으로 옮겨 학습 진행 |
| | 18. 최종 학습된 모델을 `gnn_cost_model.pt`로 저장 |
| **A\* 알고리즘** | 19. GitHub에서 검증된 A\* 알고리즘 Python 코드를 프로젝트에 통합 (`src/routing/a_star.py`) |
| | 20. A\*의 비용 계산 함수가 `기본 거리 비용 * GNN 추론 가중치`를 사용하도록 수정 |
| **Backend API** | 21. `FastAPI`를 사용하여 기본 서버(`main.py`) 및 `/route` 엔드포인트 구조 설계 |
| | 22. 서울시 버스/지하철 혼잡도 API 응답(보통, 혼잡 등)을 `정상(1.0)`, `중간(1.5)`, `혼잡(2.0)`과 같은 수치형 배율로 변환하는 모듈 작성 |

### Phase 3: 개발자용 대시보드 및 시스템 통합
- **목표:** 개발 및 디버깅 과정을 시각화할 수 있는 대시보드 구축 및 모든 컴포넌트 통합 테스트.

| 기능/컴포넌트 | 세부 Task (To-do) |
| :--- | :--- |
| **대시보드 개발** | 23. **Streamlit** 라이브러리로 대시보드 웹 앱 프레임워크 구축 (`dashboard.py`) |
| | 24. **pydeck** 라이브러리를 사용하여 대시보드에 추출된 경기장 주변 그래프(노드, 엣지) 시각화 |
| | 25. 대시보드에 '경기', '날씨', '실시간 혼잡도(가상)'를 선택할 수 있는 위젯 추가 |
| | 26. 위젯 값 변경 시, GNN이 추론한 '엣지별 비용'을 지도 위 경로 색상으로 실시간 반영 (저비용: 초록, 고비용: 빨강) |
| | 27. 대시보드에서 출발지/도착지 클릭 시, 백엔드 API를 호출하고 반환된 '쾌적 경로'를 지도 위에 파란색 선으로 표시 |
| **시스템 통합** | 28. 백엔드 API가 네이버 지도 API와 통신하여 '최단 경로', '최소 도보', '최소 환승' 옵션을 함께 반환하도록 기능 확장 |
| | 29. 모든 기능이 통합된 상태에서 로컬 환경 스트레스 테스트 진행 |

### Phase 4: 프론트엔드 연동 및 최종 검증
- **목표:** 사용자가 실제로 사용할 수 있는 웹/앱 프론트엔드 MVP 개발 및 현장 검증.

| 기능/컴포넌트 | 세부 Task (To-do) |
| :--- | :--- |
| **Frontend 개발** | 30. **React** 또는 **Vue.js** 기반의 프론트엔드 프로젝트 초기 설정 |
| | 31. Naver Map API를 연동하여 기본 지도 UI 구현 |
| | 32. **(핵심 UI)** 평상시에는 일반 지도 -> '경기장' 선택 드롭다운에서 '잠실 야구장' 선택 -> 해당 지역으로 지도 이동 및 특화 UI(좌석 블록, 경로 찾기) 활성화 |
| | 33. '경로 찾기' 버튼 클릭 시, 백엔드 API에 요청을 보내고 반환된 4가지 경로 옵션을 지도 위에 각기 다른 색상으로 표시 |
| | 34. 각 경로 선택 시, 예상 소요 시간과 경로의 특징("9호선 이용으로 혼잡을 피하는 경로")을 하단 정보창에 표시 |
| **최종 검증** | 35. 2025년 시즌 경기일에 맞춰 팀원 전원 현장 방문, 앱이 추천한 경로와 실제 체감 혼잡도 비교/분석 |
| | 36. 현장 검증 결과를 바탕으로 `subway_congestion_penalty` 등 핵심 파라미터 최종 튜닝 |
| | 37. GitHub 저장소의 `README.md`에 최종 프로젝트 결과물(시연 영상, 앱 링크) 및 팀원 역할 명시 |

---

## 4. 단계별 프로젝트 결과물 (Tangible Outputs)

### Phase 1 종료 시점
- **GitHub (`jsm0308/sports`):**
    - `README.md`: v7.0 기반의 프로젝트 명세서.
    - `requirements.txt`: 확정된 라이브러리 목록.
    - `data/raw/`: 2022-2024년 KBO/K-리그 경기 `.csv` 파일.
    - `data/processed/`: 잠실/상암 지역의 `graph.graphml` 파일.
    - `db/phoenix.db`: 경기 정보가 저장된 SQLite DB 파일.

### Phase 2 종료 시점
- **GitHub:**
    - `models/`: `attendance_model.pkl`, `gnn_cost_model.pt` v0.1 저장.
    - `src/api/main.py`: 기본 라우팅 로직이 구현된 FastAPI 서버 코드.
    - `notebooks/`: 모델 학습 및 검증 과정을 담은 Jupyter Notebook 파일.

### Phase 3 종료 시점
- **개발자 보드 (WebApp):**
    - **URL:** 로컬에서 `streamlit run dashboard.py`로 실행 가능.
    - **기능:**
        - 지도 위에 경기장 주변 도로망(인도/차도 구분) 시각화.
        - '날씨' 등 조건 변경 시, GNN이 추론한 도로별 '위험도'가 경로 색상으로 실시간 반영됨.
        - 클릭으로 경로 요청 시, 백엔드와 통신하여 추천 경로를 지도에 표시.

### Phase 4 종료 시점 (최종 결과물)
- **GitHub:**
    - 모든 소스 코드, 최종 모델, 현장 검증 리포트가 포함된 최종 버전.
- **Frontend (WebApp MVP):**
    - **UI:**
        - 기본 네이버 지도 화면.
        - **경기장 선택 드롭다운 메뉴.**
        - 경기장 선택 시 활성화되는 **'좌석 블록' 선택 메뉴**와 **목적지 검색창**.
    - **기능:**
        - '경로 찾기' 실행 시, 지도 위에 **파란색(쾌적)**, **초록색(최단)**, **주황색(최소도보)**, **보라색(최소환승)** 4가지 경로가 동시에 표시됨.
        - 각 경로 선택 시, 하단에 예상 소요 시간과 경로의 특징이 텍스트로 표시됨.

